name: AI Security Check

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ai-security-check:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
        
    - name: Install dependencies (Project & SDK)
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install claude-agent-sdk mcp
        
    - name: Install Cisco AI Defense MCP
      run: |
        # Clone the repository
        git clone https://github.com/nyasukun/ai-defense-mcp.git ai-defense-mcp
        
        # Install MCP dependencies
        cd ai-defense-mcp
        python -m pip install -r requirements.txt
        cd ..

    - name: Run AI Security Check
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        AIC_MANAGEMENT_API_KEY: ${{ secrets.AIC_MANAGEMENT_API_KEY }} # Needed for AI Defense MCP
      run: |
        # Run the security check script
        python scripts/ai_security_check.py

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: Apply AI Security Guardrails"
        title: "[AI Security] Apply Guardrails and Validation"
        body: |
          This Pull Request was automatically created by the AI Security Check workflow.
          
          It applies Cisco AI Defense guardrails to the codebase.
        branch: ai-security-fixes-${{ github.sha }}
        base: main
        delete-branch: true
